<link rel="import" href="../../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../stampzilla-device/stampzilla-device-lamp.html">
<link rel="import" href="../stampzilla-device/stampzilla-device-chromecast.html">
<link rel="import" href="../../../bower_components/iron-icons/hardware-icons.html">
<link rel="import" href="../../../bower_components/iron-icons/av-icons.html">

<dom-module id="stampzilla-devices">
	<template>
		<style  is="custom-style">
			:host {
				@apply(--layout-horizontal);
			    @apply(--layout-wrap);
			}

			:host > paper-card {
				box-sizing: border-box;
				min-width: 300px;
				max-width: 400px;
				margin: 4px;
				flex: 1;
		  	}
		</style>

		<template is="dom-repeat" items="{{_toArray(cards)}}">
			<paper-card heading="[[item.tag]]">
				<div class="card-content">
					<template is="dom-repeat" items="{{item.devices}}" as="device">

						<template is="dom-if" if="{{_isType('lamp',device.type)}}">
							<stampzilla-device-lamp device="[[device]]">[[device.name]]</stampzilla-device-lamp>
						</template>

						<template is="dom-if" if="{{_isType('chromecast',device.type)}}">
							<stampzilla-device-chromecast device="[[device]]">[[device.name]]</stampzilla-device-chromecast>
						</template>

					</template>
				</div>
			</paper-card>
		</template>

	</template>

	<script>
		(function () {
			Polymer({
				is: 'stampzilla-devices',
				properties: {
					devices: {
						type: Object,
						notify: true
					},
					cards: {
						type: Array,
						notify: true,
					}
				},
				observers: [
					'devicesChanged(devices.*)'
				],

				devicesChanged: function(changeRecord) {
					var cards = {};

					var devices = this._toArray(this.devices);
					devices.forEach(function(row) {
						var device = row.devices;
						if ( device.tags !== undefined ) {
							device.tags.forEach(function(tag) {
								tag = '#' + tag;
								if ( cards[tag] === undefined ) {
									cards[tag] = [];
								}
								cards[tag].push(device);
							});
						}

						if ( device.tags === undefined || device.tags.length === 0) {
							var tag = 'No tags specified';
							if ( cards[tag] === undefined ) {
								cards[tag] = [];
							}
							cards[tag].push(device);
						}
					});


					this.cards = cards;
					//this.favoritesOut = {test: 123};
				},


			   _toArray: function(obj) {
					return Object.keys(obj).map(function(key) {
						return {
							tag: key,
							devices: obj[key]
						};
					});
				},
				
				_isType(type, device) {
					return device === type;
				}
			});
		})();
	</script>

</dom-module>
