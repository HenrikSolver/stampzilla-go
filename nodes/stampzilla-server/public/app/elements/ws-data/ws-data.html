<dom-module id="ws-data">
	<template>
		<style>
			:host {
				display: none;
			}
		</style>
		<x-websocket id="socket" json auto url="{{url}}" message="{{message}}"></x-websocket>
	</template>

	<script>
		(function () {
			'use strict';
			new Polymer({
				is: 'ws-data',
				properties: {
					url: {
						type: String,
						value: 'ws://'+location.hostname+':8080/socket',
						notify: true
					},
					nodes: {
						type: Array,
						notify: true,
					},
					message: {
						type: Object,
						notify: true,
						observer: 'newMessage'
					}
				},
				_toArray: function(obj) {
					if(!obj){
						return [];
					}
					return Object.keys(obj).map(function(key) {
						return obj[key];
					});
				},
				_getHref: function(myAttrib) {
					return '/nodes/' + myAttrib;
				},
				//https://www.polymer-project.org/1.0/docs/devguide/properties.html 
				newMessage: function(d) {
					console.log(d);

					if(d.type === 'all'){
						var ts = moment().format('YYYY-MM-DD HH:mm:ss');
						console.log(ts);

						var tmp = this._toArray(d.data);
						tmp.forEach(function(el,index){
							tmp[index].LastSeen = ts;
						});
						this.nodes = tmp;
						return;
					}
					if(d.type === 'singlenode'){
						d.data.LastSeen = moment().format('YYYY-MM-DD HH:mm:ss');
					
						this.nodes.forEach(function(el,index){
							if( d.data !== undefined && el.Uuid === d.data.Uuid){
								// Update the node
								this.set('nodes.'+index, d.data);
								// Make sure that is is not added to the nodelist
								delete(d.data);
							}
						}, this);

						if ( d.data !== undefined ) {
							this.push('nodes',d.data);
						}
					}
					if(d.type === 'disconnected'){
						this.removeNode(d.data);
					}

				},
				removeNode: function(uuid){
					var i = -1;
					this.nodes.forEach(function(el,index){
						if(el.Uuid === uuid){
							i = index;
						}
					});

					if(i !== -1){
						this.splice('nodes', i, 1);
					}

				},
				ready: function() {
					var self = this;
					app.addEventListener('ws-send', function (e) {
						self.$.socket.send(e.detail);
					});
				}
			});
		})();
	</script>

</dom-module>
