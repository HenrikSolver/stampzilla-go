<link rel="import" href="../../bower_components/iron-form/iron-form.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-toggle-button/paper-toggle-button.html">

<dom-module id="stampzilla-device-dialog-common">
	<template>
		<style  is="custom-style">
			:host {
				@apply(--layout-vertical);
			    @apply(--layout-wrap);
			}

		</style>
		<form is="iron-form" id="form">
			<paper-input label="Name" name="name" value="[[device.name]]"></paper-input>
			<paper-input label="Tags (space sepparated)" name="tags" value="[[device.tags]]"></paper-input>

			<h4>Parameters</h4>
			<table>
				<template is="dom-repeat" items="{{_toArray(device.config)}}" as="config" sort="_sort">
					<tr>
						<td>[[config.name]]</td>
						<td>
							<template is="dom-if" if="{{_isType(config.type, 'bool')}}">
								<paper-toggle-button></paper-toggle-button>
							</template>
							<template is="dom-if" if="{{_isSet(config.options)}}">
								<paper-dropdown-menu >
									<paper-listbox class="dropdown-content">
										<template is="dom-repeat" items="{{_toArray(config.options)}}">
											<paper-item>[[item]]</paper-item>
										</template>
									</paper-listbox>
								</paper-dropdown-menu>
							</template>
						</td>
					</tr>
				</template>
			</table>
			<paper-button id="save" raised><iron-icon icon="icons:save"></iron-icon> Save</paper-button>
		</form>
	</template>

	<script>
		(function () {
			Polymer({
				is: 'stampzilla-device-dialog-common',
				properties: {
					device: {
						type: Object,
						notify: true,
						observer: 'deviceChanged'
					}
				},
				deviceChanged: function() {
				},
				listeners: {
					'save.click': 'save',
					'form.iron-form-presubmit': 'presubmit'
				},
				presubmit: function(event) {
					event.preventDefault();

					var pkg = {
						type: 'devices/set',
						data: this.$.form.serialize()
					};
					pkg.data.uuid = this.device.node+"."+this.device.id;

					app.fire('ws-send', pkg);

					this.fire('stampzilla-dialog-dismiss')
				},
				save: function() {
					this.$.form.submit();
				},
				_toArray: function(obj) {
					return Object.keys(obj).map(function(key) {
						return obj[key];
					});
				},
				_sort: function(a, b) {
					if (a.name === b.name) return 0;
					return a.name.localeCompare(b.name);
				},
				_isType(type, config) {
					return config === type;
				},
				_isSet(type) {
					return type !== undefined;
				}
			});
		})();
	</script>

</dom-module>
