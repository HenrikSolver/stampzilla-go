<dom-module id="ws-data">
	<template>
		<style>
			:host {
				display: block;
			}
			#dialog {
				width:400px;
			}
		</style>

		<paper-dialog 
			id="dialog"
			modal="true" 
			entry-animation="scale-up-animation"
			exit-animation="fade-out-animation"
			on-iron-overlay-closed="setNewUrl"
		>
			<h2>Change connection url</h2>
			<paper-checkbox checked="[[connected]]" disabled> Connected</paper-checkbox>
			<paper-input label="text input" value="{{newUrl}}"></paper-input>
	  	  <div class="buttons">
			<paper-button dialog-dismiss>Cancel</paper-button>
			<paper-button dialog-confirm>Done</paper-button>
		  </div>
		</paper-dialog>

		<x-websocket id="socket" json auto={{auto}} url="{{url}}" message="{{message}}"></x-websocket>

		<paper-toast id="toast" duration="0" class="fit-bottom" text="Not connected"></paper-toast>
	</template>

	<script>
		(function () {
			'use strict';
			new Polymer({
				is: 'ws-data',
				properties: {
					url: {
						type: String,
						notify: true,
						observer: 'urlChanged'
					},
					newUrl: {
						type: String,
						notify: true
					},

					parameters: {
						type: Object,
						value:{
							version: ''
						},
						notify: true,
					},
					nodes: {
						type: Array,
						value:[],
						notify: true,
					},
					actions: {
						type: Array,
						value:[{'name':'actions-test'}, {'name':'test2'}],
						notify: true,
					},
					actionRunners: {
						type: Array,
						value:[],
						notify: true,
					},
					rules: {
						type: Array,
						value:[{'name':'rules-test'}, {'name':'test2'}],
						notify: true,
					},
					schedule: {
						type: Array,
						value:[{'name':'schedule-test'}, {'name':'test2'}],
						notify: true,
					},

					message: {
						type: Object,
						notify: true,
						observer: 'newMessage'
					},
					connected: {
						type: Boolean,
						notify: true
					},
					auto: {
						type: Boolean,
						notify: true
					}
				},
				_toArray: function(obj) {
					if(!obj){
						return [];
					}
					return Object.keys(obj).map(function(key) {
						return obj[key];
					});
				},
				_getHref: function(myAttrib) {
					return '/nodes/' + myAttrib;
				},
				//https://www.polymer-project.org/1.0/docs/devguide/properties.html 
				newMessage: function(d) {
					switch(d.type) {
					case undefined:
						return;
					case 'parameters':
						this.parameters = d.data;
						return;
					case 'nodes/all':
						var ts = moment().format('YYYY-MM-DD HH:mm:ss');
						
						var tmp = this._toArray(d.data);
						tmp.forEach(function(el,index){
							tmp[index].LastSeen = ts;
						});
						this.nodes = tmp;
						return;
					case 'nodes/single':
						d.data.LastSeen = moment().format('YYYY-MM-DD HH:mm:ss');
					
						this.nodes.forEach(function(el,index){
							if( d.data !== undefined && el.Uuid === d.data.Uuid){
								// Update the node
								this.set('nodes.'+index, d.data);
								// Make sure that is is not added to the nodelist
								delete(d.data);
							}
						}, this);

						if ( d.data !== undefined ) {
							this.push('nodes',d.data);
						}
						return;
					case 'nodes/disconnected':
						this.removeNode(d.data);
						return;

					case 'actions/all':
						this.actions = d.data;
						return;
					case 'actions/runners':
						this.actionRunners = d.data;
						return;

					case 'rules/all':
						this.rules = d.data;
						return;
					case 'schedule/all':
						this.schedule = d.data;
						return;
					default:
						console.error('Lost websocket message type: '+ d.type, d);
						break;
					}
				},
				removeNode: function(uuid){
					var i = -1;
					this.nodes.forEach(function(el,index){
						if(el.Uuid === uuid){
							i = index;
						}
					});

					if(i !== -1){
						this.splice('nodes', i, 1);
					}

				},
				ready: function() {
					var self = this;
					app.addEventListener('ws-send', function (e) {
						self.$.socket.send(e.detail);
					});

					this.addEventListener('open',function() {
						self.$.dialog.open();
					});

					this.$.socket.addEventListener('open',function(event) {
						event.stopPropagation();
						self.$.toast.close();
						self.connected = true;
					});
					this.$.socket.addEventListener('close',function() {
						self.$.toast.open();
						self.connected = false;
					});
					this.$.socket.addEventListener('error',function() {
						self.$.toast.open();
						self.connected = false;
					});


					this.auto = true;
					var url = window.localStorage.getItem('stampzilla-url');
					if ( !url ) {
						this.url = 'ws://'+location.hostname+':8080/socket';
					} else {
						this.url = url;
					}

				},
				urlChanged: function() {
					this.newUrl = this.url;
				},
				setNewUrl: function(c, d) {
					if ( !d.confirmed ) {
						return;
					}
					window.localStorage.setItem('stampzilla-url', /** @type {string} */ (this.newUrl));
					this.url = this.newUrl;
				}
			});
		})();
	</script>

</dom-module>
