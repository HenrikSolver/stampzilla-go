<dom-module id="node-element">
	<style>
		:host {
			@apply(--layout-horizontal);
			@apply(--shadow-elevation-2dp);

			margin-bottom:10px;
			padding:1em;

		}

		:host:hover {
			@apply(--shadow-elevation-6dp);
		}

		#action {
			@apply(--layout-flex-2);
		}
		#title {
			@apply(--layout-flex);
			text-align:right;
		}

	</style>
	<template>
		<paper-shadow z="1"></paper-shadow>
			<template is="dom-if" if="{{isText}}">
				<div id="action" style="width:200px;">{{State}}</div>
				<div id="title">{{element.Name}}</div>
			</template>
			<template is="dom-if" if="{{isButton}}">
				<div id="action" style="width:200px;">
						<paper-button raised on-click="handleClick">{{element.Name}}</paper-button>
				</div>
			</template>
			<template is="dom-if" if="{{isToggle}}">
				<div id="action" style="width:200px;">
					<paper-checkbox on-change="handleToggle" checked="{{State}}"></paper-checkbox>
				</div>
				<div id="title">{{element.Name}}</div>
			</template>
			<template is="dom-if" if="{{isSlider}}">
				<div id="action" >
					<paper-slider on-immediate-value-change="handleSlide" pin immediateValue="{{immediateValue}}" value="{{State}}"></paper-slider>
				</div>
				<div id="title">{{element.Name}}</div>
			</template>
			<template is="dom-if" if="{{isColorpick}}">
				<div id="action" style="width:200px;">
						colorpick
				</div>
				<div id="title">{{element.Name}}</div>
			</template>
	</template>
	<script>
		(function () {
			Polymer({
				immediateValue:0,
				isText: false,
				is: 'node-element',
				properties: {
					element: {
						type: Object,
						notify: true
					},
					node: {
						type: Object,
						notify: true
					}
				},
				observers: [
					'stateChanged(node)',
					'elementChanged(element)'
				],
				stateChanged: function() {
				},
				elementChanged: function() {
					if(!this.node){
						return;
					}

					var state = this.byString(this.node.State,this.element.Feedback);
					// Only update state when we have a valid state and it is changed
					if( state !== undefined && (this.prevState === undefined || state !== this.prevState) ) {
						this.set('State', state);
						this.prevState = state;
					} 

					this.ready();
				},
				ready: function() {
					this.isText = this.element.Type === 0;
					this.isButton = this.element.Type === 1;
					this.isToggle = this.element.Type === 2;
					this.isSlider = this.element.Type === 3;
					this.isColorpick = this.element.Type === 4;
				},
				byString: function(o,s){
					s = s.replace(/\[(\w+)\]/g, '.$1'); // convert indexes to properties
					s = s.replace(/^\./, '');           // strip a leading dot
					var a = s.split('.');
					for (var i = 0, n = a.length; i < n; ++i) {
						var k = a[i];
						if (k in o) {
							o = o[k];
						} else {
							return;
						}
					}
					return o;
				},




				handleClick: function() {
					var cmd = this.element.Command;
					cmd.params = null;

					var pkg = {
						type: 'cmd',
						data: cmd, 
						to: this.node.Uuid,
					};

					app.fire('ws-send', pkg);
				},
				handleToggle: function() {
					var cmd = this.element.Command;
					cmd.params = [this.State];

					var pkg = {
						type: 'cmd',
						data: cmd, 
						to: this.node.Uuid,
					};

					app.fire('ws-send', pkg);
				},
				handleSlide: function(e) {
					var cmd = this.element.Command;
					cmd.params = [e.target.immediateValue];

					var pkg = {
						type: 'cmd',
						data: cmd, 
						to: this.node.Uuid
					};

					app.fire('ws-send', pkg);
				}
			});
		})();
	</script>

</dom-module>
